# 第3章: リフレッシュトークンによるトークン更新

この章では、有効期限が切れたアクセストークンを、ユーザーの再ログインなしで更新するための「リフレッシュトークンフロー」について解説します。

## 1. リフレッシュトークンとは

アクセストークン（JWT）はセキュリティの観点から有効期限が短く設定されています（通常60〜90分）。有効期限が切れた後もアプリを使い続けるために使われるのが **リフレッシュトークン** です。

*   **アクセストークン**: リソース（API）へのアクセス鍵。短命。
*   **リフレッシュトークン**: 新しいアクセストークンを発行してもらうための引換券。長寿命。

## 2. トークン更新の仕組み

クライアント（アプリ）は、リフレッシュトークンを Microsoft Entra ID のトークンエンドポイントに送信し、新しいアクセストークンと交換します。

### リクエスト (POST)
エンドポイント: `https://login.microsoftonline.com/{tenant_id}/oauth2/v2.0/token`

必要なパラメータ:
*   `grant_type`: `refresh_token`
*   `client_id`: アプリケーションのID
*   `scope`: 要求する権限（スペース区切り）
*   `refresh_token`: 現在持っているリフレッシュトークン

### レスポンス (JSON)
成功すると、以下のセットが返されます。
1.  **新しいアクセストークン** (`access_token`)
2.  **新しいリフレッシュトークン** (`refresh_token`)
    *   ※セキュリティのため、リフレッシュトークンも使うたびに新しいものに交換されます（**トークンローテーション**）。

## 3. 有効期限と「90日」のルール

リフレッシュトークンの有効期限は「固定」ではなく、条件によって異なります。

| シナリオ | 有効期限 (未使用期間) | 備考 |
| :--- | :--- | :--- |
| **基本 (ネイティブアプリ等)** | **90日** | 使えば期限が更新される（スライド式）。 |
| **SPA (シングルページアプリ)** | **24時間** | ブラウザのセキュリティ制約（ITP等）への対応のため短い。 |

*   **スライド式有効期限 (Rolling Window)**:
    トークンを使用（更新）するたびに、新しく発行されたトークンの有効期限はそこから90日（または24時間）にリセットされます。
*   **注意点**:
    SPAとして登録されたアプリ（Dynamics 365などを含む）の場合、**毎日（24時間以内）** 更新を行わないと、リフレッシュトークン自体が失効し、再ログインが必要になります。

## 4. 実装のポイント (Python)

今回の検証コード (`refresh_token_client.py`) での重要な学びは以下の通りです。

1.  **`Origin` ヘッダーの重要性**:
    *   SPAとして登録されているアプリのトークンを扱う場合、ブラウザからのリクエストであることを模倣するために `Origin` ヘッダーが必須になることがあります。これがないと `invalid_request` エラーが発生します。
2.  **トークンの差分確認**:
    *   更新前後でリフレッシュトークンの値が変わることを確認しました。古いトークンは破棄し、新しいトークンを保存して次回の更新に使う必要があります。

## 5. 実行方法

このスクリプトを実行するには、環境変数の設定が必要です。

1.  `.env.example` をコピーして `.env` ファイルを作成します。
    ```bash
    cp .env.example .env
    # Windows (PowerShell) の場合: copy .env.example .env
    ```
2.  `.env` ファイルを開き、ご自身のテナントID、クライアントIDなどを入力してください。
3.  ブラウザから取得したリフレッシュトークンを `refresh_token.txt` に保存します。
4.  スクリプトを実行します。
    ```bash
    uv run refresh_token_client.py
    ```

## 6. 設定値（Client ID, Scope等）の確認方法

スクリプトを動かすために必要な情報は、以下の2つの方法で確認できます。

### 方法A: ブラウザの開発者ツールから取得（手軽な検証用）
実際にブラウザでアプリ（Dynamics 365やAzure Portalなど）を使っている時の通信を覗き見ます。

1.  ブラウザで **F12** キーを押して開発者ツールを開く。
2.  **[Network] (ネットワーク)** タブを開く。
3.  検索フィルタに `token` と入力する。
4.  アプリを操作して、トークン更新が発生するのを待つ（またはページをリロードする）。
5.  `token` への **POST** リクエストを探し、**[Payload] (ペイロード)** タブを見る。
    *   `client_id`: クライアントID
    *   `scope`: スコープ
    *   `refresh_token`: リフレッシュトークン

### 方法B: Azure Portal で確認（正規の方法）
自分が管理者の場合、Azure Portal から正確な情報を確認できます。

1.  [Azure Portal](https://portal.azure.com) にログイン。
2.  **[Microsoft Entra ID]** > **[アプリの登録 (App registrations)]** へ移動。
3.  対象のアプリケーションを選択。
    *   **概要 (Overview)**: `アプリケーション (クライアント) ID`、`ディレクトリ (テナント) ID` が表示されます。
    *   **API のアクセス許可 (API permissions)**: アプリに許可されている `Scope` の一覧が確認できます。
