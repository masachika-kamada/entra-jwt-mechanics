# 第1章: JWTの構造とデコード

この章では、アクセストークン（JWT）の基本的な構造と、エンコード・デコードの仕組みについて解説します。

## 1. アクセストークン (JWT) の仕組み

アクセストークンは、認証済みのユーザーがリソース（APIなど）にアクセスする許可証です。Microsoft ID プラットフォームでは、**JWT (JSON Web Token)** という形式が使われています。

### JWTの構造
JWTは `.`（ドット）で区切られた3つの部分から成ります。

```
ヘッダー.ペイロード.署名
(Header).(Payload).(Signature)
```

1.  **ヘッダー (Header)**
    *   トークンの種類 (JWT) や署名アルゴリズム (RS256など) が書かれています。
2.  **ペイロード (Payload)**
    *   ユーザー情報（ID、名前、メールアドレス）や権限（スコープ）などのデータが入っています。
    *   **注意**: ここはBase64デコードすれば**誰でも見ることができます**。機密情報（パスワードなど）は含めません。
3.  **署名 (Signature)**
    *   トークンが改ざんされていないことを証明するための「ハンコ」です。
    *   Microsoft Entra ID の秘密鍵で署名されており、API側は公開鍵を使って検証します。

## 2. エンコードとデコードの仕組み (Base64)

JWTの文字列（`ey...`）は、**Base64Url** というルールでエンコードされています。

*   **エンコード (Encode)**: データを通信しやすい文字形式に変換すること。暗号化ではありません。
*   **デコード (Decode)**: エンコードされた文字を元のデータに戻すこと。

### Base64変換のアルゴリズム
「文字単位」ではなく「ビット単位」で区切り直すのが特徴です。

1.  **ビット変換**: 文字をコンピュータの言葉（0と1）に直します。（例: `{` → `01111011`）
2.  **6ビット区切り**: 通常の8ビット区切りではなく、**6ビットずつ**に区切り直します。
3.  **文字への変換**: 6ビットの数字（0〜63）を、対応する64種類の文字（A-Z, a-z, 0-9, -, _）に置き換えます。

| 変換前 (JSON) | `{"` |
| :--- | :--- |
| 1. ビット列 | `01111011` `00100010` ... |
| 2. 6ビット区切り | `011110` (30) \| `110010` (50) ... |
| 3. 変換表 | 30=`e`, 50=`y` |
| **変換後 (Base64)** | **`ey`** |

### なぜエンコードするのか？
中身を隠すためではなく、以下の理由で行われます。

1.  **安全な配送**: URLやHTTPヘッダーに含めても、文字化けや破損が起きないようにするため（「カプセル」に入れるイメージ）。
2.  **厳密な検証**: スペースや改行の有無による表記揺れを防ぎ、署名の計算を正確に行うため。

## 3. トークンの中身（クレーム）の解説

実際のアクセストークンに含まれる主な情報の解説です。
※値はプライバシー保護のため、模擬的な値（ダミー）に置き換えています。

### ヘッダー (Header)
トークンのメタデータです。

| 項目 (Claim) | 値の例 | 説明 |
| :--- | :--- | :--- |
| `typ` | `JWT` | **Type**。トークンの種類。「これはJWTですよ」という宣言（名札）。 |
| `alg` | `RS256` | **Algorithm**。署名の作り方。**RSA**暗号と**SHA-256**ハッシュ関数の組み合わせ。 |
| `kid` | `PcX9...` | **Key ID**。署名検証に使う「公開鍵」を特定するためのID。 |
| `x5t` | `PcX9...` | **X.509 Certificate Thumbprint**。署名に使われた証明書の「指紋（ハッシュ値）」。どの証明書を使えばよいかの目印。 |

#### ※ `RS256` の意味
*   **256 (SHA-256)**: データを要約して「256ビット（0と1が256個）」の指紋を作る技術。文字数ではありません。
*   **RS (RSA)**: その指紋を「秘密鍵」で暗号化する技術。
*   **署名の文字数（約342文字）の計算式**:
    1.  Microsoft Entra IDの署名鍵の長さは **2048ビット** です。
    2.  Base64は **「6ビットを1文字にする」** ルールです。
    3.  したがって、文字数は $2048 \div 6 = 341.33...$ となり、切り上げて **342文字** になります。

### ペイロード (Payload)
ユーザーや権限に関する情報（クレーム）です。

| 項目 (Claim) | 値の例 (ダミー) | 説明 | 参考リンク |
| :--- | :--- | :--- | :--- |
| `aud` | `https://api.example.com` | **Audience**。このトークンは「誰（どのAPI）」のために発行されたか。 | [詳細](https://learn.microsoft.com/ja-jp/entra/identity-platform/access-tokens#payload-claims) |
| `iss` | `https://sts.windows.net/1111.../` | **Issuer**。発行者（Microsoft Entra IDのテナント）。 | [詳細](https://learn.microsoft.com/ja-jp/entra/identity-platform/access-tokens#payload-claims) |
| `iat` | `1767335240` | **Issued At**。発行日時（UNIX時間）。 | |
| `exp` | `1767339203` | **Expiration Time**。有効期限（UNIX時間）。通常は発行から約1時間。 | |
| `nbf` | `1767335240` | **Not Before**。この時間になるまでトークンは有効にならない。 | |
| `sub` | `CWk5...` | **Subject**。ユーザーを一意に識別するID（ペアワイズ識別子の場合あり）。 | [詳細](https://learn.microsoft.com/ja-jp/entra/identity-platform/id-tokens#payload-claims) |
| `oid` | `00000000-0000-...` | **Object ID**。テナント内でユーザーを一意に識別する不変のID。 | [詳細](https://learn.microsoft.com/ja-jp/entra/identity-platform/id-tokens#payload-claims) |
| `tid` | `11111111-1111-...` | **Tenant ID**。所属する組織（テナント）のID。 | |
| `name` | `John Doe` | ユーザーの表示名。 | |
| `upn` / `unique_name` | `user@example.com` | **User Principal Name**。ユーザーのサインインID（メールアドレス形式）。 | |
| `scp` | `User.Read Files.Read` | **Scope**。このトークンで許可されている**権限（スコープ）**のリスト。 | [詳細](https://learn.microsoft.com/ja-jp/entra/identity-platform/access-tokens#payload-claims) |
| `amr` | `["pwd", "mfa"]` | **Authentication Methods References**。認証方法（パスワード、多要素認証など）。 | [詳細](https://learn.microsoft.com/ja-jp/entra/identity-platform/claims-mapping) |
| `ipaddr` | `192.168.0.1` | 認証時のクライアントIPアドレス。 | |
| `appid` | `065d...` | トークンを要求したクライアントアプリケーションのID。 | |

## 4. 実践ツール: `decode_jwt.py`

アクセストークンをデコードして、中身（ヘッダーとペイロード）を表示するPythonスクリプトです。

**使い方:**
1. プロジェクトルートに `access_token` という名前のファイルを作成し、中にアクセストークン（`ey...`）を貼り付けます。
2. スクリプトを実行します。
   ```bash
   python decode_jwt.py
   ```
